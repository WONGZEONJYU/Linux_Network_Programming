# (å››) selectå¤šè·¯å¤ç”¨

â“é—®é¢˜ : å¦‚ä½•å¢å¼ºæœåŠ¡ç«¯èƒ½åŠ›,åŒæ—¶æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯?

# 1.Linuxè®¾è®¡å“²å­¦ : ä¸€åˆ‡çš†æ–‡ä»¶

><img src="./assets/image-20230812185704878.png" alt="image-20230812185704878" />

## 1.1 Linux ä¸­çš„æ–‡ä»¶æ˜¯ä»€ä¹ˆ?

>- ç‹­ä¹‰ï¼š
>   - æ–‡ä»¶ç³»ç»Ÿä¸­ç‰©ç†æ„ä¹‰ä¸Šçš„æ–‡ä»¶ (é€»è¾‘ä¸Šå…³è”çš„æ•°æ®é›†åˆ)
>- å¹¿ä¹‰ï¼š
>   - è®¾å¤‡ , ç®¡é“ , å†…å­˜ , ã€‚ã€‚ã€‚
>   - Linuxç®¡ç†çš„ä¸€åˆ‡å¯¹è±¡
>

## 1.2 ç†è§£æ–‡ä»¶æè¿°ç¬¦ ( `File Descriptor` )

>- æ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ä¸ª `éè´Ÿæ•´æ•°å€¼` , æœ¬è´¨æ˜¯ä¸€ä¸ªå¥æŸ„
>- **$\color{red}{ä¸€åˆ‡å¯¹ç”¨æˆ· ( ç¨‹åºå‘˜ ) é€æ˜çš„èµ„æºæ ‡è¯†éƒ½å¯ä»¥çœ‹ä½œå¥æŸ„}$**
>- ç”¨æˆ·ä½¿ç”¨ `æ–‡ä»¶æè¿°ç¬¦` ( å¥æŸ„ ) ä¸å†…æ ¸äº¤äº’
>- å†…æ ¸é€šè¿‡ `æ–‡ä»¶æè¿°ç¬¦` ( å¥æŸ„ ) æ“ä½œå¯¹åº”èµ„æºçš„æ•°æ®ç»“æ„

## 1.3 ä¸€åˆ‡çš†æ–‡ä»¶çš„æ„ä¹‰

>- ç»Ÿä¸€å„ç§è®¾å¤‡çš„æ“ä½œæ–¹å¼ (open, read, write, close)
>- ä¸€å¦‚ : 
>   - 10è®¾å¤‡ (å‘½ä»¤è¡Œ , æ˜¾ç¤ºå™¨)
>   - ç½‘ç»œè®¾å¤‡ (ç½‘å¡)
>

## 1.4 Linuxæ–‡ä»¶æ“ä½œç¼–ç¨‹æ¨¡å¼

><img src="./assets/image-20230812212448578.png" alt="image-20230812212448578" />

## 1.5 ç¼–ç¨‹å®éªŒ

>[[å‚è€ƒé“¾æ¥ğŸ”—]](https://github.com/WONGZEONJYU/STU_LINUX_NETWORK/blob/main/5.fd_operator/fd_operator.cpp)
>
>```c++
>#include <cstdio>
>#include <unistd.h>
>#include <iostream>
>
>using namespace std;
>
>int main()
>{
>    int iofd {0};
>
>    char s[] {"Hello World!\r\n"};
>
>    write(iofd,s,sizeof(s));
>
>    int len (read(iofd,s,5));
>
>    s[len] = 0;
>
>    cout << "read : " << s << '\n';
>
>    return 0;
>}
>
>```
>
><img src="./assets/image-20230812213206678.png" alt="image-20230812213206678" />

# 2. äº‹ä»¶å¤„ç†

## 2.1 äº‹ä»¶ç›¸å…³å‡½æ•°çš„åˆ†ç±»

### 2.1.1 é˜»å¡å¼å‡½æ•°

>- å‡½æ•°è°ƒç”¨åéœ€è¦ **$\color{red}{ç­‰å¾…}$** æŸä¸ªäº‹ä»¶å‘ç”Ÿåæ‰ä¼šè¿”å›
>- `read(...)` , `scanf(...)` , `accept(...)`

### 2.1.2 éé˜»å¡å¼å‡½æ•°

> - å‡½æ•°è°ƒç”¨åèƒ½å¤ŸåŠæ—¶è¿”å› (**$\color{red}{ä»…æ ‡è®°ç­‰å¾…çš„äº‹ä»¶}$**)
> - äº‹ä»¶å‘ç”Ÿåä»¥ **$\color{red}{å›è°ƒæ–¹å¼}$** ä¼ é€’

## 2.2 é˜»å¡ VS è½®è¯¢

>- è½®è¯¢æŒ‡ä¾åºè¯¢é—®æ¯ä¸€ä¸ªç›¸å…³è®¾å¤‡æ˜¯å¦éœ€è¦æœåŠ¡çš„æ–¹å¼
>- è½®è¯¢å¯ç”¨äºè§£å†³é˜»å¡å‡½æ•°å¯¼è‡´ç¨‹åºæ— æ³•ç»§ç»­æ‰§è¡Œçš„é—®é¢˜
>
><img src="./assets/image-20230812215304167.png" alt="image-20230812215304167" />

# 3. å…³äº`select(...)`

## 3.1 `select(...)` å‡½æ•°

>- `select(...)` ç”¨äºç›‘è§†æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦äº§ç”Ÿäº‹ä»¶
>- å¯é€šè¿‡è½®è¯¢çš„æ–¹å¼æ£€æµ‹ç›®æ ‡äº‹ä»¶ (äº‹ä»¶äº§ç”Ÿåˆ™æ ‡è®°å‘ç”Ÿå˜åŒ–)
>- æ ¹æ®äº‹ä»¶ç±»å‹åšå‡ºå…·ä½“å¤„ç† (å¦‚ : è¯»å–æ•°æ®)
>
><img src="./assets/image-20230812222556951.png" alt="image-20230812222556951" />
>
>```tex
>è¿”å›å€¼:selectæˆåŠŸæ—¶è¿”å›å°±ç»ª(å¯è¯»ã€å¯å†™å’Œå¼‚å¸¸)æ–‡ä»¶æè¿°ç¬¦çš„æ€»æ•°ã€‚å¦‚æœåœ¨è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰ä»»ä½•æ–‡ä»¶æè¿°ç¬¦å°±ç»ª,selectå°†è¿”å›0ã€‚selectå¤±è´¥æ—¶è¿”å›-1ã€‚å¦‚æœåœ¨selectç­‰å¾…æœŸé—´ï¼Œç¨‹åºæ¥æ”¶åˆ°ä¿¡å·ï¼Œåˆ™selectç«‹å³è¿”å›-1ï¼Œå¹¶è®¾ç½®errnoä¸ºEINTRã€‚
>
>maxfdï¼šå‚æ•°æŒ‡å®šçš„è¢«ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦çš„æ€»æ•°ã€‚å®ƒé€šå¸¸è¢«è®¾ç½®ä¸º select ç›‘å¬çš„æ‰€
>æœ‰æ–‡ä»¶æè¿°ç¬¦ä¸­çš„æœ€å¤§å€¼+1,å› ä¸ºæè¿°ç¬¦æ˜¯ä»0å¼€å§‹è®¡æ•°çš„ã€‚
>
>readfdsã€writefds å’Œ exceptfdsï¼š æŒ‡å‘å¯è¯»ã€å¯å†™å’Œå¼‚å¸¸ç­‰äº‹ä»¶å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆã€‚åº”ç”¨ç¨‹åºè°ƒç”¨ select å‡½æ•°æ—¶,é€šè¿‡è¿™ 3 ä¸ªå‚æ•°ä¼ å…¥è‡ªå·±æ„Ÿå…´è¶£çš„æ–‡ä»¶æè¿°ç¬¦ã€‚select è¿”å›æ—¶,å†…æ ¸å°†ä¿®æ”¹å®ƒä»¬æ¥é€šçŸ¥åº”ç”¨ç¨‹åºå“ªäº›æ–‡ä»¶æè¿°ç¬¦å·²ç»å°±ç»ªã€‚
>```

## 3.2 ä½¿ç”¨æ­¥éª¤

><img src="./assets/image-20230813142404652.png" alt="image-20230813142404652" />

## 3.3 ç›¸å…³æ•°æ®ç±»å‹åŠæ“ä½œ

><img src="./assets/image-20230813142612960.png" alt="image-20230813142612960" />

## 3.4 è½®è¯¢ç¤ºä¾‹

><img src="./assets/image-20230813143137468.png" alt="image-20230813143137468" />

## 3.5 ç¼–ç¨‹å®éªŒ

>[[å‚è€ƒé“¾æ¥]](https://github.com/WONGZEONJYU/STU_LINUX_NETWORK/blob/main/6.select_test/select.cpp)
>
>```c++
>#include <sys/select.h>
>#include <sys/time.h>
>#include <cstdio>
>#include <unistd.h>
>#include <iostream>
>
>using namespace std;
>
>int main(int argc,char* argv[])
>{
>    int iofd {};
>    char s[] {"Hello World!\r\n"};
>    fd_set reads{};
>    
>    FD_ZERO(&reads);
>    FD_SET(iofd,&reads);
>
>    int counter{};
>
>    while (true){
>        
>        fd_set temps{reads};//selectå‡½æ•°ä¼šå½±å“tempsçš„å€¼ï¼Œæ‰€ä»¥æ¯æ¬¡æˆ‘ä»¬éƒ½éœ€è¦æ‹·è´ä¸€æ¬¡ä»¥ç¡®ä¿ä¸ä¼šå‡ºé”™
>        timeval timeout{.tv_sec = 0,.tv_usec = 50000};
>
>        int r {select(1,&temps,nullptr,nullptr,&timeout)};
>
>        if (r > 0){
>
>            cout << "r :" << r << '\n';
>
>            int len (read(iofd,s,(sizeof(s) - 1)));
>
>            s[len] = 0;
>
>            cout << "Input: " << s << '\n';
>
>        }else if (0 == r){
>            usleep(1000);
>            if (++counter > 100){
>                cout << "do something else\n";
>                counter = 0;
>            }
>        }else{
>            break;
>        }
>    }
>    
>    return 0;
>}
>
>```
>
><img src="./assets/image-20230813152848838.png" alt="image-20230813152848838" />

æ€è€ƒ: 
ä½¿ç”¨ `select(...)` å‡½æ•°å¯ä»¥æ‰©å±•æœåŠ¡ç«¯åŠŸèƒ½å— ?
å¦‚å¦‚æœå¯ä»¥ , å…·ä½“æ€ä¹ˆå®ç° ?